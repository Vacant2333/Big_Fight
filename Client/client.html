<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <title>球球大作战</title>
        <script src="https://s3.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://unpkg.com/spritejs@3/dist/spritejs.js"></script>
    </head>
    <body>
    <div id="game" style="height: 800px; width: 800px;"></div>
    </body>
</html>

<script>
//spritejs 渲染
const {Scene, Sprite, Ring} = spritejs;
const container = document.getElementById('game');
const scene = new Scene(
    {
        container,
        width: 800,
        height: 800,
    });
const layer = scene.layer();

//渲染边框border
const border = new Sprite(
    {
        anchor: [0, 0],
        size: [798, 798],
        pos: [0, 0],
        bgcolor: '#9e9e9e',
        borderWidth: 1,
        borderRadius: 8,
    });
layer.append(border);

//渲染类
class DrawEnity
{
    all_stuff_data = [];
    all_stuff_class = [];

    drawAllStuff()
    {
        this.clearAllStuff();
        for(var key = 0; key < this.all_stuff_data.length; key++)
        {
            var stuff_data = this.all_stuff_data[key];
            var stuff_class = new Ring(
                {
                    pos: [stuff_data['coordinate'][0], stuff_data['coordinate'][1]],
                    innerRadius: 0,
                    outerRadius: stuff_data['area'],
                    fillColor: 'red',
                });
            layer.append(stuff_class);
            this.all_stuff_class.push(stuff_class);
        }
    }

    setAllStuffData(data)
    {
        this.all_stuff_data = data;
    }

    //清空AllStuffClass
    clearAllStuff()
    {
        for(var key = 0; key < this.all_stuff_class.length; key++)
        {
            //清除元素
            this.all_stuff_class[key].remove();
        }
        //清空数组
        this.all_stuff_class.splice(0);
    }
}

var DE = new DrawEnity();

//更新数据
function update()
{
    try
    {
        websocket.send('update');
        DE.drawAllStuff();
    }
    catch(e)
    {
        console.log('update faild.');
    }
}

//WebScoket通信
websocket = new WebSocket('ws://39.96.4.47:8001');
websocket.onopen = function (evt)
{
    console.log("Connected to WebSocket server.");
    //连接成功 计时器循环
    setInterval('update()', 50);
};
websocket.onclose = function (evt)
{
    console.log("Disconnected");
};
websocket.onmessage = function (evt)
{
    DE.setAllStuffData(JSON.parse(evt.data));
};
</script>