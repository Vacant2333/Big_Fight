<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <title>球球大作战</title>
        <script src="https://s3.pstatp.com/cdn/expire-1-M/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://unpkg.com/spritejs@3/dist/spritejs.js"></script>
    </head>
    <body>
    <div id="stage" style="height: 800px; width: 800px;"></div>
    </body>
</html>

<script>
//SpriteJS
const {Scene, Sprite, Ring} = spritejs;
const container = document.getElementById('stage');
const scene = new Scene(
    {
        container,
        width: 800,
        height: 800
    });
const border = new Sprite(
    {
        anchor: [0, 0],
        size: [798, 798],
        pos: [0, 0],
        bgcolor: '#9e9e9e',
        borderWidth: 1,
        borderRadius: 5
    });
const layer = scene.layer();
layer.append(border);
</script>
<script>
class StageDraw
{
    all_stuff_data = [];
    all_stuff_class =[];

    all_player_data = [];
    all_player_class = [];

    //渲染
    draw()
    {
        this.clearClass();
        this.drawPlayer();
        this.drawStuff();
    }

    //清空class
    clearClass()
    {
        for(var key = 0; key < this.all_stuff_class.length; key++)
        {
            this.all_stuff_class[key].remove();
        }
        for(var key = 0; key < this.all_player_class.length; key++)
        {
            this.all_player_class[key].remove();
        }

        this.all_stuff_class.splice(0);
        this.all_player_class.splice(0);
    }

    setData(name, data)
    {
        switch(name)
        {
            case 'stuff':
                this.all_stuff_data = data;
                break;
            case 'player':
                this.all_player_data = data;
                break;
        }
    }

    drawStuff()
    {
        for(var key = 0; key < this.all_stuff_data.length; key++)
        {
            var stuff_data = this.all_stuff_data[key];
            var stuff_class = new Ring(
                {
                    pos: [stuff_data['coordinate']['x'], stuff_data['coordinate']['y']],
                    innerRadius: 0,
                    outerRadius: stuff_data['radius'],
                    fillColor: '#ff5722e6',
                });
            layer.append(stuff_class);
            this.all_stuff_class.push(stuff_class);
        }
    }

    drawPlayer()
    {
        for(var key = 0; key < this.all_player_data.length; key++)
        {
            var player_data = this.all_player_data[key];
            var player_class = new Ring(
                {
                    pos: [player_data['coordinate']['x'], player_data['coordinate']['y']],
                    innerRadius: 0,
                    outerRadius: player_data['radius'],
                    fillColor: '#03a9f4bf',
                });
            layer.append(player_class);
            this.all_player_class.push(player_class);
        }
    }
}


var SD = new StageDraw();

//WebScoket
websocket = new WebSocket('ws://39.96.4.47:8001');

websocket.onopen = function(event)
{
    console.log("Connected to WebSocket server.");

    //连接成功 发送更新请求
    setInterval(function()
    {
        websocket.send('update');
    }, 50);
};

websocket.onclose = function(event)
{
    console.log("Disconnected");
};

websocket.onmessage = function(event)
{
    data = JSON.parse(event.data);
    switch(data['name'])
    {
        case 'update':
            SD.setData('stuff', data['data']['stuff']);
            SD.setData('player', data['data']['player']);
            SD.draw();
            break;
    }
};
</script>